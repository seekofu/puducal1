<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>普渡計算機</title>
    
    <!-- PWA 與獨立 App 設置 -->
    <meta name="theme-color" content="#f8f9f8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="普渡計算機">
    
    <!-- iOS 圖示 (增加邊距的版本) -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/plasticine/200/box.png">

    <!-- 動態 Manifest 注入 (優化圖示邊距與配色) -->
    <script id="pwa-manifest">
        const manifest = {
            "name": "普渡計算機",
            "short_name": "普渡計算機",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f8f9f8",
            "theme_color": "#4b5340",
            "icons": [
                {
                    // 使用帶有內縮邊距的咖啡色紙箱圖示，避免被裁切
                    "src": "https://img.icons8.com/plasticine/192/box.png",
                    "sizes": "192x192",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "https://img.icons8.com/plasticine/192/box.png",
                    "sizes": "192x192",
                    "type": "image/png",
                    "purpose": "maskable"
                },
                {
                    "src": "https://img.icons8.com/plasticine/512/box.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --tab-bar-height: 72px;
            --primary-text: #2d3426;
            --highlight-text: #b45309;
        }
        html, body {
            height: 100%;
            height: 100dvh;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            overscroll-behavior: none;
            background-color: #f8f9f8;
            touch-action: manipulation;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            position: relative;
            padding-top: env(safe-area-inset-top);
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .soft-shadow {
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
        }
        .tab-bar {
            background-color: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid #e2e8f0;
            z-index: 100;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .tab-content-wrapper {
            height: var(--tab-bar-height);
            display: flex;
            justify-content: space-around;
            align-items: stretch;
        }
        .tab-btn {
            color: #64748b; 
            font-size: 0.75rem;
            font-weight: 700;
            transition: all 0.3s ease;
            position: relative;
            padding: 8px 0;
        }
        .tab-btn.active {
            color: var(--primary-text); 
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: #4b5340;
            border-radius: 99px;
        }
        .content-scroll {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: calc(var(--tab-bar-height) + env(safe-area-inset-bottom) + 80px); 
        }
        .floating-clear-btn {
            position: fixed;
            right: 20px;
            bottom: calc(env(safe-area-inset-bottom) + var(--tab-bar-height) + 15px);
            width: 56px;
            height: 56px;
            background-color: #cbd5e1; 
            color: #1e293b; 
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.25rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 90;
            border: none;
        }
        .push-down { margin-top: 5rem; }
        .text-label { color: #475569; font-weight: 700; }
        .olive-bg { background-color: #f0f1ed; }
    </style>
</head>
<body class="text-slate-900">

    <header class="py-3 px-6 text-center shrink-0">
        <h1 class="text-lg font-black text-[#4b5340] opacity-60">普渡計算機</h1>
    </header>

    <button id="global-clear-btn" class="floating-clear-btn">C</button>

    <main class="content-scroll px-6">
        <section id="section-unit" class="flex flex-col min-h-full">
            <div class="pt-2">
                <div class="grid grid-cols-2 gap-px bg-slate-200 rounded-3xl overflow-hidden soft-shadow">
                    <div class="bg-white p-7 text-center">
                        <p class="text-[10px] font-bold text-slate-500 tracking-widest mb-3 uppercase">換算組數</p>
                        <div class="text-4xl font-extrabold text-[#2d3426]"><span id="res_boxes">0</span></div>
                    </div>
                    <div class="bg-white p-7 text-center">
                        <p class="text-[10px] font-bold text-slate-500 tracking-widest mb-3 uppercase">剩餘散包</p>
                        <div class="text-4xl font-extrabold text-[#b45309]"><span id="res_remain">0</span></div>
                    </div>
                </div>
            </div>
            <div class="push-down space-y-5">
                <div>
                    <label class="block text-[11px] text-label tracking-widest mb-2 ml-1 uppercase">總數量</label>
                    <input type="number" id="total_units" class="w-full bg-white p-5 rounded-2xl text-3xl font-bold text-[#2d3426] soft-shadow outline-none text-center focus:ring-2 focus:ring-slate-200" placeholder="請輸入總數" inputmode="numeric">
                </div>
                <div>
                    <label class="block text-[11px] text-label tracking-widest mb-2 ml-1 uppercase">幾入裝</label>
                    <input type="number" id="units_per_box" class="w-full bg-white p-5 rounded-2xl text-3xl font-bold text-[#2d3426] soft-shadow outline-none text-center focus:ring-2 focus:ring-slate-200" placeholder="請輸入數量" inputmode="numeric">
                </div>
            </div>
        </section>

        <section id="section-stack" class="hidden flex flex-col min-h-full">
            <div class="pt-2">
                <div class="grid grid-cols-2 gap-px bg-slate-200 rounded-3xl overflow-hidden soft-shadow">
                    <div class="bg-white p-7 text-center">
                        <p class="text-[10px] font-bold text-slate-500 tracking-widest mb-3 uppercase">單層數量</p>
                        <div class="text-4xl font-extrabold text-slate-700"><span id="summary-layer">0</span></div>
                    </div>
                    <div class="bg-white p-7 text-center">
                        <p class="text-[10px] font-bold text-slate-500 tracking-widest mb-3 uppercase">剩餘散包</p>
                        <div class="text-4xl font-extrabold text-[#b45309]"><span id="summary-top">0</span></div>
                    </div>
                </div>
            </div>
            <div class="push-down space-y-5">
                <div>
                    <label class="block text-[11px] text-label tracking-widest mb-2 ml-1 uppercase">待堆疊總數</label>
                    <input type="number" id="stack_total" class="w-full bg-white p-5 rounded-2xl text-3xl font-bold text-[#2d3426] soft-shadow outline-none text-center focus:ring-2 focus:ring-slate-200" placeholder="請輸入總數" inputmode="numeric">
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-white p-4 rounded-xl soft-shadow text-center">
                        <label class="block text-[10px] font-bold text-slate-500 tracking-widest mb-1.5 uppercase">排</label>
                        <input type="number" id="row_l" class="w-full text-3xl font-bold text-slate-800 outline-none text-center bg-transparent" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="bg-white p-4 rounded-xl soft-shadow text-center">
                        <label class="block text-[10px] font-bold text-slate-500 tracking-widest mb-1.5 uppercase">列</label>
                        <input type="number" id="row_w" class="w-full text-3xl font-bold text-slate-800 outline-none text-center bg-transparent" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="olive-bg p-4 rounded-xl soft-shadow text-center border border-slate-200">
                        <label class="block text-[10px] font-bold text-[#4b5340] tracking-widest mb-1.5 uppercase">層數</label>
                        <input type="number" id="row_h" class="w-full text-3xl font-black text-[#b45309] outline-none text-center olive-bg" placeholder="0" inputmode="numeric">
                    </div>
                </div>
            </div>
        </section>

        <section id="section-count" class="hidden flex flex-col min-h-full">
            <div class="pt-2">
                <div class="bg-white rounded-3xl overflow-hidden soft-shadow p-7 text-center">
                    <p class="text-[10px] font-bold text-slate-500 tracking-widest mb-3 uppercase">總合計數量</p>
                    <div class="text-4xl font-extrabold text-[#b45309]"><span id="grand-total">0</span></div>
                </div>
            </div>
            <div class="pt-6">
                <button onclick="addStackItem()" class="w-full py-4 bg-white border-2 border-dashed border-slate-300 rounded-2xl text-slate-600 text-xs font-black active:scale-95 transition-all">
                    + 新增堆疊區塊
                </button>
            </div>
            <div class="mt-6">
                <label class="text-[11px] text-label tracking-widest uppercase ml-1 block mb-3">堆疊清單</label>
                <div id="stack-list" class="space-y-4">
                    <div class="stack-item bg-white p-5 rounded-2xl soft-shadow">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-[11px] font-black text-slate-500 tracking-widest uppercase">區域 A</span>
                            <div class="flex items-center bg-slate-100 px-4 py-1.5 rounded-full">
                                <span class="text-[10px] font-bold text-slate-500 mr-2 uppercase">小計</span>
                                <span class="text-xl font-black text-[#2d3426] subtotal">0</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <input type="number" class="val-r w-full text-3xl font-bold text-center bg-slate-50 rounded-lg py-3 outline-none" placeholder="排" oninput="calcCountTotal()" inputmode="numeric">
                            <input type="number" class="val-c w-full text-3xl font-bold text-center bg-slate-50 rounded-lg py-3 outline-none" placeholder="列" oninput="calcCountTotal()" inputmode="numeric">
                            <input type="number" class="val-l w-full text-3xl font-bold text-center bg-slate-50 rounded-lg py-3 outline-none" placeholder="層" oninput="calcCountTotal()" inputmode="numeric">
                            <input type="number" class="val-s w-full text-3xl font-black text-center bg-amber-50 rounded-lg py-3 outline-none text-amber-700" placeholder="散" oninput="calcCountTotal()" inputmode="numeric">
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <nav class="tab-bar">
        <div class="tab-content-wrapper">
            <button onclick="switchTab('unit')" id="tab-unit" class="tab-btn active flex-1 flex flex-col items-center justify-center gap-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                <span>組數換算</span>
            </button>
            <button onclick="switchTab('stack')" id="tab-stack" class="tab-btn flex-1 flex flex-col items-center justify-center gap-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                <span>堆疊計算</span>
            </button>
            <button onclick="switchTab('count')" id="tab-count" class="tab-btn flex-1 flex flex-col items-center justify-center gap-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                <span>清點合計</span>
            </button>
        </div>
    </nav>

    <script>
        (function() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    const swContent = `
                        const CACHE_NAME = 'pudu-cache-v6';
                        self.addEventListener('install', event => self.skipWaiting());
                        self.addEventListener('activate', event => event.waitUntil(clients.claim()));
                        self.addEventListener('fetch', event => {
                            event.respondWith(fetch(event.request).catch(() => caches.match(event.request)));
                        });
                    `;
                    const blob = new Blob([swContent], { type: 'text/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    if (window.isSecureContext) {
                        navigator.serviceWorker.register(swUrl, { scope: './' }).catch(() => {});
                    }
                });
            }
        })();

        let currentActiveTab = 'unit';
        document.getElementById('global-clear-btn').addEventListener('click', () => {
            if (currentActiveTab === 'unit') clearUnit();
            else if (currentActiveTab === 'stack') clearStack();
            else if (currentActiveTab === 'count') clearCount();
        });

        function switchTab(tab) {
            currentActiveTab = tab;
            ['unit', 'stack', 'count'].forEach(t => {
                const section = document.getElementById(`section-${t}`);
                const btn = document.getElementById(`tab-${t}`);
                if (section) section.classList.toggle('hidden', t !== tab);
                if (btn) btn.classList.toggle('active', t === tab);
            });
            document.querySelector('.content-scroll').scrollTo(0, 0);
        }

        function unitConvert() {
            const total = parseInt(document.getElementById('total_units').value) || 0;
            const perBox = parseInt(document.getElementById('units_per_box').value) || 0;
            const boxes = perBox > 0 ? Math.floor(total / perBox) : 0;
            const remain = perBox > 0 ? total % perBox : 0;
            document.getElementById('res_boxes').innerText = boxes;
            document.getElementById('res_remain').innerText = remain;
        }
        document.getElementById('total_units').addEventListener('input', unitConvert);
        document.getElementById('units_per_box').addEventListener('input', unitConvert);

        function stackCalc(field) {
            const total = parseInt(document.getElementById('stack_total').value) || 0;
            const l = parseInt(document.getElementById('row_l').value) || 0;
            const w = parseInt(document.getElementById('row_w').value) || 0;
            const hInput = document.getElementById('row_h');
            let h = parseInt(hInput.value) || 0;
            if (field !== 'h' && l > 0 && w > 0) {
                h = Math.floor(total / (l * w));
                hInput.value = h;
            }
            const layerQty = l * w;
            const remain = layerQty > 0 ? total - (layerQty * h) : total;
            document.getElementById('summary-layer').innerText = layerQty;
            document.getElementById('summary-top').innerText = Math.max(0, remain);
        }
        ['stack_total', 'row_l', 'row_w', 'row_h'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => stackCalc(id === 'row_h' ? 'h' : 'other'));
        });

        let stackCount = 1;
        function addStackItem() {
            stackCount++;
            const char = String.fromCharCode(64 + (stackCount > 26 ? 26 : stackCount));
            const div = document.createElement('div');
            div.className = "stack-item bg-white p-5 rounded-2xl soft-shadow";
            div.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <span class="text-[11px] font-black text-slate-500 tracking-widest uppercase">區域 ${char}</span>
                    <div class="flex items-center bg-slate-100 px-4 py-1.5 rounded-full">
                        <span class="text-[10px] font-bold text-slate-500 mr-2 uppercase">小計</span>
                        <span class="text-xl font-black text-[#2d3426] subtotal">0</span>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <input type="number" class="val-r w-full text-3xl font-bold text-center bg-slate-50 rounded-lg py-3 outline-none" placeholder="排" oninput="calcCountTotal()" inputmode="numeric">
                    <input type="number" class="val-c w-full text-3xl font-bold text-center bg-slate-50 rounded-lg py-3 outline-none" placeholder="列" oninput="calcCountTotal()" inputmode="numeric">
                    <input type="number" class="val-l w-full text-3xl font-bold text-center bg-slate-50 rounded-lg py-3 outline-none" placeholder="層" oninput="calcCountTotal()" inputmode="numeric">
                    <input type="number" class="val-s w-full text-3xl font-black text-center bg-amber-50 rounded-lg py-3 outline-none text-amber-700" placeholder="散" oninput="calcCountTotal()" inputmode="numeric">
                </div>
            `;
            document.getElementById('stack-list').appendChild(div);
        }

        function calcCountTotal() {
            let total = 0;
            document.querySelectorAll('.stack-item').forEach(el => {
                const r = parseInt(el.querySelector('.val-r').value) || 0;
                const c = parseInt(el.querySelector('.val-c').value) || 0;
                const l = parseInt(el.querySelector('.val-l').value) || 0;
                const s = parseInt(el.querySelector('.val-s').value) || 0;
                const sub = (r * c * l) + s;
                el.querySelector('.subtotal').innerText = sub;
                total += sub;
            });
            document.getElementById('grand-total').innerText = total;
        }

        function clearUnit() {
            document.getElementById('total_units').value = '';
            document.getElementById('units_per_box').value = '';
            unitConvert();
        }
        function clearStack() {
            document.getElementById('stack_total').value = '';
            document.getElementById('row_l').value = '';
            document.getElementById('row_w').value = '';
            document.getElementById('row_h').value = '';
            stackCalc('other');
        }
        function clearCount() {
            const list = document.getElementById('stack-list');
            const items = list.querySelectorAll('.stack-item');
            items[0].querySelectorAll('input').forEach(i => i.value = '');
            items[0].querySelector('.subtotal').innerText = '0';
            while (list.children.length > 1) list.removeChild(list.lastChild);
            stackCount = 1;
            calcCountTotal();
        }
    </script>
</body>
</html>